<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Chat AI Lead Generation Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Remove checkbox row highlighting that makes text unreadable */
        .table tbody tr.table-active {
            background-color: transparent !important;
        }
        
        /* Custom checkbox selection indication - subtle border instead */
        .table tbody tr.selected-row {
            border-left: 3px solid #0d6efd !important;
        }
        
        /* Ensure text remains readable when rows are selected */
        .table tbody tr.selected-row td {
            background-color: transparent !important;
        }
        
        /* Keep the green animation for new sessions */
        .new-session-highlight {
            transition: all 0.6s cubic-bezier(0.4, 0.0, 0.2, 1);
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        .user-info {
            position: fixed;
            top: 20px;
            right: 80px;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .user-badge {
            background-color: var(--bs-primary);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
        }
        [data-bs-theme="dark"] .user-badge {
            background-color: var(--bs-info);
        }
        .stats-card {
            transition: transform 0.2s;
        }
        .stats-card:hover {
            transform: translateY(-5px);
        }
        /* Custom 5-column layout for stats cards */
        .col-lg-2-4 {
            flex: 0 0 auto;
            width: 20%;
        }
        @media (max-width: 991.98px) {
            .col-lg-2-4 {
                width: 50%;
            }
        }
        @media (max-width: 575.98px) {
            .col-lg-2-4 {
                width: 100%;
            }
        }
        .ticket-table th {
            background-color: var(--bs-primary);
            color: white;
        }
        [data-bs-theme="dark"] .ticket-table th {
            background-color: var(--bs-dark);
        }
        
        /* Remove old table-info styling - now using subtle border selection */
        
        /* Checkbox styling for better visibility */
        .ticket-checkbox {
            transform: scale(1.2);
            margin: 0 auto 0 8px;
            display: block;
            border: 1px solid #6c757d !important;
        }
        .checkbox-column {
            text-align: left;
            vertical-align: middle;
            width: 50px;
            padding-left: 12px !important;
        }
        
        /* Table cell vertical alignment */
        .ticket-table td, .ticket-table th {
            vertical-align: middle;
        }
        
        /* Sender column styling */
        .sender-column {
            max-width: 200px;
            min-width: 200px;
            width: 200px;
        }
        
        .sender-column .text-truncate {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* Force single-line layout for filters */
        .row.flex-nowrap {
            overflow-x: auto;
            white-space: nowrap;
        }
        
        .row.flex-nowrap .col-auto {
            flex-shrink: 0;
        }
        
        /* Dark mode improvements */
        [data-bs-theme="dark"] {
            --bs-dark-rgb: 10, 10, 10;
            --bs-body-bg: #0a0a0a;
        }
        [data-bs-theme="dark"] body {
            background-color: #0a0a0a !important;
        }
        [data-bs-theme="dark"] h1 {
            color: #ffffff !important;
        }
        [data-bs-theme="dark"] .btn-outline-secondary {
            color: #ffffff;
            border-color: #ffffff;
        }
        [data-bs-theme="dark"] .btn-outline-secondary:hover {
            background-color: #ffffff;
            color: #000000;
        }
        [data-bs-theme="dark"] .form-control,
        [data-bs-theme="dark"] .form-select {
            background-color: #1a1a1a;
            border-color: #444;
            color: #ffffff;
        }
        [data-bs-theme="dark"] .form-control:focus,
        [data-bs-theme="dark"] .form-select:focus {
            background-color: #1a1a1a;
            border-color: #60a5fa;
            color: #ffffff;
            box-shadow: 0 0 0 0.2rem rgba(96, 165, 250, 0.25);
        }
        [data-bs-theme="dark"] .form-control::placeholder {
            color: #aaa;
        }
        [data-bs-theme="dark"] .btn-outline-info {
            color: #ffffff;
            border-color: #ffffff;
        }
        [data-bs-theme="dark"] .btn-outline-info:hover {
            background-color: #ffffff;
            color: #000000;
        }
        [data-bs-theme="dark"] .btn-primary {
            background-color: #60a5fa;
            border-color: #60a5fa;
        }
        [data-bs-theme="dark"] .btn-primary:hover {
            background-color: #3b82f6;
            border-color: #3b82f6;
        }
        [data-bs-theme="dark"] .table {
            color: #ffffff;
        }
        [data-bs-theme="dark"] .table td,
        [data-bs-theme="dark"] .table th {
            color: #ffffff;
            border-color: #444;
        }
        [data-bs-theme="dark"] .card {
            background-color: #1a1a1a;
            border-color: #444;
        }
        
        /* Logo styling */
        .logo-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .logo-img {
            width: 200px;
            height: auto;
        }
        .logo-container h2 {
            font-size: 1.3rem;
            margin-bottom: 0;
        }
        
        /* Stats card tooltips */
        .stats-card {
            position: relative;
        }
        
        .stats-card .info-icon {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 16px;
            height: 16px;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: #333;
            cursor: help;
        }
        
        /* QA Reviewer input styling for dark mode - strongest selectors */
        input[id="qa_reviewer"],
        input[name="qa_reviewer"],
        .modal input[id="qa_reviewer"],
        .modal input[name="qa_reviewer"],
        .modal-body input[id="qa_reviewer"],
        .modal-content input[id="qa_reviewer"],
        [data-bs-theme="dark"] input[id="qa_reviewer"],
        [data-bs-theme="dark"] input[name="qa_reviewer"] {
            background-color: #1a1a1a !important;
            border: 1px solid #444 !important;
            color: #ffffff !important;
        }
        
        input[id="qa_reviewer"]:focus,
        input[name="qa_reviewer"]:focus,
        .modal input[id="qa_reviewer"]:focus,
        .modal input[name="qa_reviewer"]:focus,
        .modal-body input[id="qa_reviewer"]:focus,
        .modal-content input[id="qa_reviewer"]:focus,
        [data-bs-theme="dark"] input[id="qa_reviewer"]:focus,
        [data-bs-theme="dark"] input[name="qa_reviewer"]:focus {
            background-color: #1a1a1a !important;
            border-color: #60a5fa !important;
            color: #ffffff !important;
            box-shadow: 0 0 0 0.2rem rgba(96, 165, 250, 0.25) !important;
        }
        
        /* Modal backdrop styling - stronger blur and positioning */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.95) !important;
            backdrop-filter: blur(25px) saturate(180%) !important;
            -webkit-backdrop-filter: blur(25px) saturate(180%) !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            z-index: 1040 !important;
            width: 100vw !important;
            height: 100vh !important;
        }
        
        /* Additional blur for content behind modals */
        .modal.show ~ .container,
        .modal.show ~ * {
            filter: blur(8px) !important;
            -webkit-filter: blur(8px) !important;
        }
        
        /* Ensure modal content is not blurred */
        .modal-dialog {
            filter: none !important;
            -webkit-filter: none !important;
        }
        
        /* Darken the ticket details modal when reopen confirmation is shown */
        .modal-dimmed {
            position: relative;
        }
        
        .modal-dimmed::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1040;
            border-radius: 0.375rem;
        }
        
        /* Additional styling for the reopen modal */
        #reopenConfirmModal .modal-content {
            box-shadow: 0 1rem 3rem rgba(0, 0, 0, 0.6);
            border: none;
            z-index: 1050;
        }
        
        #reopenConfirmModal .modal-header {
            border-bottom: 2px solid var(--bs-success);
        }
        
        /* Ensure reopen modal appears above the dimmed background */
        #reopenConfirmModal {
            z-index: 1055;
        }
        
        /* Test AI Modal Styling */
        .test-ai-modal {
            position: fixed !important;
            top: 50px;
            right: 50px;
            width: 400px;
            height: 500px;
            background: var(--bs-body-bg);
            border: 1px solid var(--bs-border-color);
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            z-index: 99999 !important;
            display: none;
            resize: both;
            overflow: hidden;
            min-width: 350px;
            min-height: 400px;
        }
        
        .test-ai-modal.show {
            display: block;
        }
        
        .test-ai-header {
            background: var(--bs-primary);
            color: white;
            padding: 12px 16px;
            cursor: move;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--bs-border-color);
        }
        
        .test-ai-header-buttons {
            display: flex;
            align-items: center;
        }
        
        .test-ai-refresh {
            padding: 4px 8px;
            font-size: 12px;
            border: 1px solid rgba(255,255,255,0.3);
            background: transparent;
            color: white;
        }
        
        .test-ai-refresh:hover {
            background: rgba(255,255,255,0.1);
            border-color: rgba(255,255,255,0.5);
            color: white;
        }
        
        .test-ai-header h5 {
            margin: 0;
            flex: 1;
        }
        
        .test-ai-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .test-ai-close:hover {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }
        
        .test-ai-body {
            display: flex;
            flex-direction: column;
            height: calc(100% - 60px);
        }
        
        .test-ai-notice {
            padding: 16px 16px 0 16px;
            transition: transform 0.4s ease-out, opacity 0.4s ease-out;
        }
        
        .test-ai-notice.hidden {
            transform: translateY(-100%);
            opacity: 0;
            pointer-events: none;
        }
        
        .test-ai-notice .alert {
            margin-bottom: 0;
            background-color: #fff3cd;
            border-color: #ffeaa7;
            color: #856404;
        }
        
        .test-ai-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            border-bottom: 1px solid var(--bs-border-color);
            transition: padding-top 0.4s ease-out;
        }
        
        .test-ai-messages.notice-hidden {
            padding-top: 0;
        }
        
        .test-ai-input-area {
            padding: 16px;
            background: var(--bs-gray-100);
        }
        
        [data-bs-theme="dark"] .test-ai-input-area {
            background: var(--bs-gray-900);
        }
        
        .message {
            margin-bottom: 12px;
            padding: 8px 12px;
            border-radius: 8px;
            max-width: 85%;
        }
        
        .message.user {
            background: #2c3e50;
            color: white;
            margin-right: auto;
            text-align: left;
            border: 1px solid #34495e;
        }
        
        .message.ai {
            background: var(--bs-primary);
            color: white;
            margin-left: auto;
            text-align: right;
        }
        
        .test-ai-input {
            width: 100%;
            border: 1px solid var(--bs-border-color);
            border-radius: 6px;
            padding: 8px 12px;
            background: var(--bs-body-bg);
            color: var(--bs-body-color);
            resize: none;
        }
        
        .test-ai-input:focus {
            outline: none;
            border-color: var(--bs-primary);
            box-shadow: 0 0 0 2px rgba(var(--bs-primary-rgb), 0.25);
        }
        
        .send-btn {
            margin-top: 8px;
            width: 100%;
        }
        
        /* Prevent blur effect on Test AI modal */
        .test-ai-modal,
        .test-ai-modal * {
            filter: none !important;
            -webkit-filter: none !important;
        }
        
        /* Ensure Test AI modal is always on top and clickable */
        body.modal-open .test-ai-modal {
            filter: none !important;
            -webkit-filter: none !important;
            z-index: 99999 !important;
            pointer-events: auto !important;
            position: fixed !important;
        }
        
        /* Ensure Test AI modal input areas are always interactive */
        .test-ai-modal .test-ai-input,
        .test-ai-modal .send-btn,
        .test-ai-modal .test-ai-header,
        .test-ai-modal .test-ai-close,
        .test-ai-modal .test-ai-refresh,
        .test-ai-modal .test-ai-input-area,
        .test-ai-modal textarea,
        .test-ai-modal input {
            pointer-events: auto !important;
            z-index: 100000 !important;
            position: relative !important;
        }
        
        /* Override any modal backdrop interference - force interaction capability */
        .test-ai-modal {
            isolation: isolate !important;
            pointer-events: auto !important;
        }
        
        /* Override Bootstrap modal backdrop interference */
        .modal-backdrop ~ .test-ai-modal,
        .modal-backdrop ~ .test-ai-modal * {
            pointer-events: auto !important;
        }
        
        /* Force Test AI modal inputs to be interactive even when other modals are open */
        body.modal-open .test-ai-modal textarea,
        body.modal-open .test-ai-modal input,
        body.modal-open .test-ai-modal button {
            pointer-events: auto !important;
            z-index: 100001 !important;
        }
        
        /* Session Details Chat Styling */
        .session-message {
            display: flex;
            flex-direction: column;
        }
        
        .session-message.user-message {
            align-items: flex-start;
        }
        
        .session-message.ai-message {
            align-items: flex-end;
        }
        
        .message-bubble {
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <!-- Header with logout -->
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div class="logo-container">
                        <img src="{{ url_for('static', filename='izzyagents_logo_white.png') }}" alt="IzzyAgents Logo" class="logo-img">
                    </div>
                    <div class="d-flex justify-content-center align-items-center w-100">
                        <h1 class="mb-0 text-center" id="dashboardTitle" style="font-size: 1.6rem;">
                            <span id="dashboardText">Stay Golden Health AI Messenger Sessions Dashboard</span>
                        </h1>
                    </div>
                    <div class="d-flex align-items-center gap-3" style="white-space: nowrap;">
                        <button class="btn btn-outline-info d-flex align-items-center" id="testAIBtn" style="padding: 8px 16px;">
                            <i class="fas fa-robot me-2"></i><span>Test AI</span>
                        </button>
                        <a href="{{ url_for('logout') }}" class="btn btn-outline-danger d-flex align-items-center" style="padding: 8px 16px;">
                            <i class="fas fa-sign-out-alt me-2"></i><span>Logout</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mode removed - only Messenger Sessions now -->

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="row mb-3">
                    <div class="col-12">
                        {% for category, message in messages %}
                            <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
        {% endwith %}

        <!-- Stats Dashboard -->
        <div class="row mb-4" id="statsContainer">
            <div class="col-12 text-center">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        </div>

        <!-- Daily Statistics Chart -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <button class="btn btn-link text-decoration-none p-0" type="button" data-bs-toggle="collapse" data-bs-target="#dailyStatsChart" aria-expanded="false" aria-controls="dailyStatsChart">
                                    <i class="fas fa-chart-bar me-2"></i>Activity Statistics
                                    <i class="fas fa-chevron-down ms-2" id="chartToggleIcon"></i>
                                </button>
                            </h5>
                            <div class="btn-group" role="group" id="chartControls" style="display: none;">
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="changeChartType('line')">
                                    <i class="fas fa-chart-line me-1"></i>Line
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm active" onclick="changeChartType('bar')">
                                    <i class="fas fa-chart-bar me-1"></i>Bar
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="collapse" id="dailyStatsChart">
                        <div class="card-body" style="min-height: 800px;">
                            <div class="mb-3">
                                <small class="text-muted">
                                    <i class="fas fa-calendar me-1"></i>
                                    Date Range: <span id="chartDateRange">Loading...</span>
                                </small>
                            </div>
                            <div id="chartContainer" style="height: 700px; position: relative;">
                                <canvas id="dailyChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ticket Management -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-comments me-2"></i>Chat Sessions</h5>
                            <div class="d-flex align-items-center gap-2">
                                <div class="d-flex align-items-center">
                                    <label for="perPageSelect" class="form-label me-2 mb-0 text-nowrap">Show:</label>
                                    <select class="form-select form-select-sm" id="perPageSelect" onchange="changePerPage()" style="width: auto;">
                                        <option value="10">10</option>
                                        <option value="20" selected>20</option>
                                        <option value="50">50</option>
                                        <option value="100">100</option>
                                    </select>
                                </div>
                                <button class="btn btn-outline-secondary btn-sm" onclick="refreshData()" id="refreshBtn">
                                    <i class="fas fa-sync-alt me-1"></i>Refresh
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Filters -->
                        <div class="row mb-3 align-items-end g-2 flex-nowrap">
                            <div class="col-auto">
                                <label class="form-label">Status</label>
                                <select class="form-select form-select-sm" id="statusFilter" style="width: auto;">
                                    <option value="">All Statuses</option>
                                    <option value="active">Active</option>
                                    <option value="archived">Archived</option>
                                </select>
                            </div>
                            <div class="col-auto">
                                <label class="form-label">Completion Status</label>
                                <select class="form-select form-select-sm" id="completionFilter" style="width: auto;">
                                    <option value="">All</option>
                                    <option value="complete">Complete</option>
                                    <option value="in_progress">In Progress</option>
                                    <option value="incomplete">Incomplete</option>
                                </select>
                            </div>
                            <div class="col-auto">
                                <label class="form-label">Source</label>
                                <select class="form-select form-select-sm" id="sessionSourceFilter" style="width: auto;">
                                    <option value="">All Sources</option>
                                    <option value="messenger">Messenger</option>
                                    <option value="web_chat">Web Chat</option>
                                </select>
                            </div>
                            <div class="col-auto">
                                <label class="form-label">QA Status</label>
                                <select class="form-select form-select-sm" id="qaStatusFilter" style="width: auto;">
                                    <option value="">All QA Status</option>
                                    <option value="unchecked">Unchecked</option>
                                    <option value="passed">Passed</option>
                                    <option value="issue">Issue</option>
                                    <option value="fixed">Fixed</option>
                                </select>
                            </div>
                            <div class="col-auto">
                                <label class="form-label">Contact ID</label>
                                <input type="text" class="form-control form-control-sm" id="contactIdFilter" placeholder="Search by Contact ID" style="width: 180px;" oninput="handleContactIdSearch()">
                            </div>
                            <div class="col">
                                <label class="form-label">
                                    Date Range: <span class="fw-bold text-success" id="dateRangeDisplay">No range selected</span>
                                </label>
                                <div class="d-flex align-items-center gap-2">
                                    <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" id="dateRangeDropdown" data-bs-toggle="dropdown">
                                        <i class="fas fa-calendar me-1"></i>
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="#" onclick="setDateRange('today')">Today</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="setDateRange('yesterday')">Yesterday</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="setDateRange('thisWeek')">This Week</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="setDateRange('lastWeek')">Last Week</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="setDateRange('thisMonth')">This Month</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="setDateRange('lastMonth')">Last Month</a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item" href="#" onclick="clearDateRange()">Clear Filter</a></li>
                                    </ul>
                                    <input type="date" class="form-control form-control-sm" id="dateFrom" placeholder="From" style="width: 120px;">
                                    <input type="date" class="form-control form-control-sm" id="dateTo" placeholder="To" style="width: 120px;">
                                </div>
                            </div>
                            <div class="col-auto">
                                <div class="d-flex gap-2 align-items-end">
                                    <!-- Left column: Mark as Passed and Archive Selected stacked -->
                                    <div class="d-flex flex-column gap-1">
                                        <button class="btn btn-success btn-sm text-white" id="markPassedBtn" onclick="markSelectedAsPassed()" disabled style="height: 31px;">
                                            <i class="fas fa-check me-1"></i>Mark as Passed
                                        </button>
                                        <button class="btn btn-dark btn-sm" id="archiveSelectedBtn" onclick="archiveSelected()" disabled style="height: 31px;">
                                            <i class="fas fa-archive me-1"></i>Archive Selected
                                        </button>
                                    </div>
                                    <!-- Right column: Reset and Apply stacked -->
                                    <div class="d-flex flex-column gap-1">
                                        <button class="btn btn-danger btn-sm text-white" onclick="resetFilters()" id="resetFiltersBtn" style="height: 31px; width: 130px;">
                                            <i class="fas fa-times me-1 text-white"></i>Reset
                                        </button>
                                        <button class="btn btn-primary btn-sm text-white" onclick="applyFilters()" id="applyFiltersBtn" style="height: 31px; width: 130px;">
                                            <i class="fas fa-filter me-1 text-white"></i>Apply
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Tickets Table -->
                        <div id="ticketsContainer">
                            <div class="text-center">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Loading tickets...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Ticket Details Modal -->
    <div class="modal fade" id="ticketDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Session Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="ticketDetailsContent">
                    <!-- Ticket details will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Update Ticket Modal -->
    <div class="modal fade" id="updateTicketModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Update Ticket</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="updateForm">
                        <input type="hidden" id="update_inquiry_id">
                        <div class="mb-3">
                            <label for="update_status" class="form-label">Status</label>
                            <select class="form-select" id="update_status">
                                <option value="">Don't change</option>
                                <option value="pending">Pending</option>
                                <option value="processed">Processed</option>
                                <option value="ignored">Ignored</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="update_engaged" class="form-label">Engaged</label>
                            <select class="form-select" id="update_engaged">
                                <option value="">Don't change</option>
                                <option value="true">Yes</option>
                                <option value="false">No</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="update_ai_response" class="form-label">AI Response</label>
                            <textarea class="form-control" id="update_ai_response" rows="4" placeholder="Enter AI response if engaged"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-warning" onclick="updateTicket()">
                        <i class="fas fa-save me-1"></i>Update Ticket
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteConfirmModalLabel">
                        <i class="fas fa-exclamation-triangle text-warning me-2"></i>Confirm Delete
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this session? This action cannot be undone.</p>
                    <div class="alert alert-warning d-flex align-items-center" role="alert">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <div>This will permanently remove the session from the database.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                        <i class="fas fa-trash me-1"></i>Delete Session
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Archive Confirmation Modal -->
    <div class="modal fade" id="bulkArchiveConfirmModal" tabindex="-1" aria-labelledby="bulkArchiveConfirmModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="bulkArchiveConfirmModalLabel">
                        <i class="fas fa-archive text-warning me-2"></i>Confirm Archive
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="bulkArchiveMessage">Are you sure you want to archive these tickets?</p>
                    <div class="alert alert-warning d-flex align-items-center" role="alert">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <div>This action cannot be undone.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-warning" id="confirmBulkArchiveBtn">
                        <i class="fas fa-archive me-1"></i>Archive Sessions
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reopen Ticket Confirmation Modal -->
    <div class="modal fade" id="reopenConfirmModal" tabindex="-1" aria-labelledby="reopenConfirmModalLabel" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog" style="margin-top: 120px;">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="reopenConfirmModalLabel">
                        <i class="fas fa-undo text-success me-2"></i>Reopen Ticket in Gorgias
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to reopen this ticket in Gorgias?</p>
                    <div class="alert alert-info d-flex align-items-center" role="alert">
                        <i class="fas fa-info-circle me-2"></i>
                        <div>This will make the ticket active again in Gorgias and update its status in our system to "Skipped".</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" id="confirmReopenBtn">
                        <i class="fas fa-undo me-1"></i>Reopen Ticket
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Test AI Modal -->
    <div class="test-ai-modal" id="testAIModal">
        <div class="test-ai-header">
            <h5>Test AI Chat</h5>
            <div class="test-ai-header-buttons">
                <button class="test-ai-refresh btn btn-sm btn-outline-light me-2" id="refreshTestAI" title="Start New Session">
                    <i class="fas fa-refresh"></i>
                </button>
                <button class="test-ai-close" id="closeTestAI">&times;</button>
            </div>
        </div>
        <div class="test-ai-body">
            <div class="test-ai-notice" id="testAINotice">
                <div class="alert alert-warning" role="alert">
                    <i class="fas fa-info-circle me-2"></i>
                    Please enter your initial message
                </div>
            </div>
            <div class="test-ai-messages" id="testAIMessages">
                <!-- Messages will appear here -->
            </div>
            <div class="test-ai-input-area">
                <textarea class="test-ai-input" id="testAIInput" placeholder="Type your message here..." rows="2"></textarea>
                <button class="btn btn-primary send-btn" id="sendTestAI">
                    <i class="fas fa-paper-plane me-2"></i>Send
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='app.js') }}"></script>
</body>
</html>
